# docker-compose.override.yml
# This file is automatically merged with docker-compose.yml in development
# Run with: docker-compose up

services:
  app:
    # Override build to ensure development target
    build:
      target: development
    # Mount source code for hot-reload
    volumes:
      - ./src:/app/src
      - ./test:/app/test
      - ./nest-cli.json:/app/nest-cli.json
      - ./tsconfig.json:/app/tsconfig.json
      - ./tsconfig.build.json:/app/tsconfig.build.json
      # Prevent overwriting node_modules and dist from container
      - /app/node_modules
    # Override command (optional, Dockerfile already has start:dev)
    command: pnpm run start:dev
    # Development environment
    environment:
      - NODE_ENV=development
      - PORT=${PORT}
    # Expose debugger port for VS Code debugging
    ports:
      - '${PORT}:${PORT}'
      - '9229:9229'

  db:
    # Expose database port for local tools (DBeaver, pgAdmin, etc.)
    ports:
      - '${DB_PORT}:5432'

  redis:
    # Expose redis port for local tools
    ports:
      - '${REDIS_PORT}:6379'

  # pgadmin - Development only
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: boilerplate-pgadmin
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_EMAIL}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_PASSWORD}
      - PGADMIN_CONFIG_SERVER_MODE=False
      - PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED=False
    ports:
      - '${PGADMIN_HOST_PORT}:80'
    depends_on:
      - db
    networks:
      - nestjs-boilerplate-net
    volumes:
      - pgadmin-data:/var/lib/pgadmin

volumes:
  pgadmin-data:
